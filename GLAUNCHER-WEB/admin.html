<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - GLauncher</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/admin-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <link rel="icon" type="image/png" href="images/GLauncher logo.png">
</head>
<body>
    <!-- Spinner de Carga, Notificaciones y Pantalla Offline -->
    <div id="notification-container"></div>
    <div id="offline-overlay" class="offline-overlay"><div class="offline-content"><i class="fas fa-wifi"></i><h2>Sin Conexión</h2><p>Revisa tu red e inténtalo de nuevo.</p></div></div>
    
    <!-- Modal para Baneo de Usuario -->
    <div id="ban-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="ban-modal-title">Sancionar Usuario</h3>
            <form id="ban-form">
                <input type="hidden" id="ban-user-id">
                <label for="ban-duration">Duración (horas, 0 para desbanear):</label>
                <input type="number" id="ban-duration" min="0" value="24" required>
                <label for="ban-reason">Motivo:</label>
                <textarea id="ban-reason" rows="3" placeholder="Ej: Uso de lenguaje inapropiado"></textarea>
                <div class="modal-actions"><button type="submit" class="action-btn save-btn">Aplicar</button><button type="button" id="cancel-ban-btn" class="action-btn cancel-btn">Cancelar</button></div>
            </form>
        </div>
    </div>

    <header class="header">
        <div class="logo-container">
            <img src="images/GLauncher logo.png" alt="Logo de GLauncher" class="logo">
            <h1>GLauncher</h1>
        </div>
        <nav id="admin-nav" class.="auth-buttons" style="display: none;">
            <a href="index.html" class="auth-button"><i class="fas fa-home"></i> Volver al Inicio</a>
            <a href="#" id="logout-btn" class="auth-button"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
        </nav>
    </header>

    <!-- Contenido principal del panel de administración -->
    <main id="admin-main-content" class="main-content admin-page">

        <div class="admin-container">
            <!-- Columna de Navegación -->
            <aside class="admin-sidebar">
                <div class="sidebar-header">
                    <h3 class="neon-title" style="font-size: 1.5em; margin: 0;">Admin</h3>
                </div>
                <a href="#" class="admin-nav-item active" data-target="dashboard-manager"><i class="fas fa-tachometer-alt"></i> Resumen</a>
                <a href="#" class="admin-nav-item" data-target="news-manager"><i class="fas fa-newspaper"></i> Gestionar Noticias</a>
                <a href="#" class="admin-nav-item" data-target="users-manager"><i class="fas fa-users-cog"></i> Gestionar Usuarios</a>
                <a href="#" class="admin-nav-item" data-target="cosmetics-manager"><i class="fas fa-gem"></i> Gestionar Cosméticos</a>
                <a href="#" class="admin-nav-item" data-target="chat-manager"><i class="fas fa-comments"></i> Gestionar Chat</a>
                <a href="#" class="admin-nav-item" data-target="downloads-manager"><i class="fas fa-download"></i> Gestionar Descargas</a>
                <a href="#" class="admin-nav-item" data-target="settings-manager"><i class="fas fa-cogs"></i> Ajustes</a>
            </aside>

            <!-- Contenedor para las vistas principales que se alternan -->
            <div class="admin-main-view">

                <!-- SECCIÓN 0: DASHBOARD / RESUMEN -->
                <section id="dashboard-manager" class="admin-section active">
                    <div class="dashboard-header">
                        <h3><i class="fas fa-tachometer-alt"></i> Resumen</h3>
                        <button id="refresh-status-btn" class="action-btn btn-blue-outline"><i class="fas fa-sync-alt"></i> Refrescar Estado</button>
                    </div>

                    <h4 class="dashboard-subheader"><i class="fas fa-heartbeat"></i> Estado de los Servicios</h4>
                    <div class="status-grid">
                        <div class="status-card" id="status-backend">
                            <div class="status-header"><i class="fas fa-server"></i><span>Backend (API)</span></div>
                            <div class="status-indicator loading" title="Comprobando..."></div>
                            <div class="status-text">Comprobando...</div>
                        </div>
                        <div class="status-card" id="status-gemini">
                            <div class="status-header"><i class="fas fa-magic"></i><span>API de Gemini</span></div>
                            <div class="status-indicator loading" title="Comprobando..."></div>
                            <div class="status-text">Comprobando...</div>
                        </div>
                        <div class="status-card" id="status-pusher">
                            <div class="status-header"><i class="fas fa-broadcast-tower"></i><span>Pusher (Chat)</span></div>
                            <div class="status-indicator loading" title="Comprobando..."></div>
                            <div class="status-text">Comprobando...</div>
                        </div>
                    </div>

                    <h4 class="dashboard-subheader"><i class="fas fa-chart-bar"></i> Estadísticas Clave</h4>
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <i class="fas fa-users stat-icon"></i>
                            <div class="stat-value" id="stat-total-users">0</div>
                            <div class="stat-label">Usuarios Registrados</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-newspaper stat-icon"></i>
                            <div class="stat-value" id="stat-total-news">0</div>
                            <div class="stat-label">Noticias Publicadas</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-download stat-icon"></i>
                            <div class="stat-value" id="stat-total-downloads">0</div>
                            <div class="stat-label">Archivos de Descarga</div>
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN 1: GESTOR DE NOTICIAS -->
                <section id="news-manager" class="admin-section">
                    <h3><i class="fas fa-newspaper"></i> Gestionar Noticias</h3>
                    <div class="section-content-grid">
                        <!-- Columna Izquierda: Lista de Noticias -->
                        <div class="news-list-container">
                            <div class="list-header">
                                <h3>Noticias Existentes</h3>
                                <button id="add-new-btn" class="action-btn add-btn"><i class="fas fa-plus"></i> Nueva</button>
                            </div>
                            <div id="news-list" class="news-list">
                                <!-- Las noticias se cargarán aquí -->
                                <p>Cargando noticias...</p>
                            </div>
                        </div>

                        <!-- Columna Derecha: Formulario de Edición/Creación -->
                        <div class="form-container">
                            <form id="news-form">
                                <h3 id="form-title">Crear Nueva Noticia</h3>
                                <input type="hidden" id="news-id" name="id">

                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="title">Título</label>
                                        <input type="text" id="title" name="title" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="date">Fecha</label>
                                        <input type="date" id="date" name="date" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="category">Categoría</label>
                                        <select id="category" name="category" required>
                                            <option value="juego">Juego</option>
                                            <option value="oficial">Oficial</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="icon">Icono (Ej: fa-rocket)</label>
                                        <input type="text" id="icon" name="icon" placeholder="Opcional">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="summary">Resumen</label>
                                    <textarea id="summary" name="summary" rows="4" required></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="image">Imagen de la Noticia</label>
                                    <input type="file" id="image" name="image" accept="image/*">
                                    <div id="image-preview-container" style="display: none;">
                                        <img id="image-preview" src="" alt="Vista previa de la imagen">
                                    </div>
                                </div>

                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="link">URL del Botón</label>
                                        <input type="text" id="link" name="link" required placeholder="https://...">
                                    </div>
                                    <div class="form-group">
                                        <label for="buttonText">Texto del Botón</label>
                                        <input type="text" id="buttonText" name="buttonText" required placeholder="Leer más">
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" id="save-btn" class="action-btn save-btn"><i class="fas fa-save"></i> Guardar</button>
                                    <button type="button" id="cancel-btn" class="action-btn cancel-btn" style="display: none;">Cancelar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN 2: GESTOR DE USUARIOS -->
                <section id="users-manager" class="admin-section">
                    <h3><i class="fas fa-users-cog"></i> Usuarios Registrados</h3>
                    <div class="user-table-container">
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre de Usuario</th>
                                    <th>Rol y Permisos</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-body">
                                <!-- Los usuarios se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- SECCIÓN NUEVA: GESTOR DE COSMÉTICOS -->
                <section id="cosmetics-manager" class="admin-section">
                    <h3><i class="fas fa-gem"></i> Importador de Accesorios y Cosméticos</h3>
                    <div class="section-content-grid">
                        <!-- Columna Izquierda: Lista de Cosméticos -->
                        <div class="news-list-container">
                            <div class="list-header">
                                <h3>Cosméticos Existentes</h3>
                            </div>
                            <div id="cosmetics-list" class="news-list">
                                <!-- Los cosméticos se cargarán aquí -->
                                <p>Cargando cosméticos...</p>
                            </div>
                        </div>

                        <!-- Columna Derecha: Formulario de Creación -->
                        <div class="form-container">
                            <form id="cosmetic-form" enctype="multipart/form-data">
                                <h3>Añadir Nuevo Cosmético</h3>
                                <div class="form-group">
                                    <label for="cosmetic-name">Nombre del Ítem</label>
                                    <input type="text" id="cosmetic-name" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label for="cosmetic-description">Descripción</label>
                                    <textarea id="cosmetic-description" name="description" rows="3" required></textarea>
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="cosmetic-price">Precio (GCoins)</label>
                                        <input type="number" id="cosmetic-price" name="price" required min="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="cosmetic-rarity">Rareza</label>
                                        <select id="cosmetic-rarity" name="rarity" required>
                                            <option value="common">Común</option>
                                            <option value="rare">Raro</option>
                                            <option value="epic">Épico</option>
                                            <option value="legendary">Legendario</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="cosmetic-category">Categoría</label>
                                        <select id="cosmetic-category" name="category" required>
                                            <option value="Capas">Capas</option>
                                            <option value="Alas">Alas</option>
                                            <option value="Auras">Auras</option>
                                            <option value="Mascotas">Mascotas</option>
                                            <option value="Accesorios">Accesorios (Cabeza)</option>
                                            <option value="Emotes">Emotes</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group"><label>Archivos</label></div>
                                <input type="file" id="cosmetic-model-file" name="model_file" required accept=".bbmodel,.json,.obj"> <small>Modelo 3D (.bbmodel, .json)</small><br>
                                <input type="file" id="cosmetic-image-file" name="image_file" required accept="image/png, image/jpeg, image/gif"> <small>Imagen de vista previa</small>
                                
                                <div class="form-actions" style="margin-top: 20px;">
                                    <button type="submit" class="action-btn save-btn"><i class="fas fa-upload"></i> Crear Ítem</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN 3: GESTOR DE CHAT -->
                <section id="chat-manager" class="admin-section">
                    <h3><i class="fas fa-comments"></i> Herramientas del Chat de TropiRumba</h3>
                    <div class="section-content-grid">
                        <!-- Columna Izquierda: Enviar Mensajes y Reportes -->
                        <div class="form-container">
                            <form id="system-message-form">
                                <h3 id="form-title-system">Enviar Mensaje del Sistema</h3>
                                <div class="form-group">
                                    <label for="system-message-content">Contenido del Mensaje</label>
                                    <textarea id="system-message-content" name="content" rows="4" required placeholder="Ej: El servidor se reiniciará en 5 minutos."></textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="action-btn save-btn"><i class="fas fa-paper-plane"></i> Enviar a todos</button>
                                </div>
                            </form>
                        </div>
                        <!-- Columna Derecha: Vista del Chat -->
                        <div class="chat-view-container">
                            <div class="list-header">
                                <h3><i class="fas fa-eye"></i> Vista del Chat Local</h3>
                                <button id="refresh-chat-btn" class="action-btn" style="background-color: var(--neon-blue); color: var(--main-bg-color); border: none;"><i class="fas fa-sync-alt"></i> Refrescar</button>
                                <button id="delete-all-chat-btn" class="action-btn" style="background-color: var(--neon-pink); color: var(--main-bg-color); border: none;"><i class="fas fa-bomb"></i> Borrar Todo</button>
                            </div>
                            <div id="admin-chat-view" class="admin-chat-view"></div>
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN 4: GESTOR DE DESCARGAS -->
                <section id="downloads-manager" class="admin-section">
                    <h3><i class="fas fa-download"></i> Archivos para Descargar</h3>
                    <div class="section-content-grid">
                        <!-- Columna Izquierda: Lista de Descargas -->
                        <div class="news-list-container">
                            <div class="list-header">
                                <h3>Archivos Disponibles</h3>
                            </div>
                            <div id="downloads-list" class="news-list">
                                <!-- Las descargas se cargarán aquí -->
                            </div>
                        </div>
                        <!-- Columna Derecha: Formulario para añadir descarga -->
                        <div class="form-container">
                            <form id="download-form" enctype="multipart/form-data">
                                <h3>Añadir Nuevo Archivo</h3>
                                <div class="form-group">
                                    <label for="platform">Plataforma</label>
                                    <select id="platform" name="platform" required>
                                        <option value="Windows">Windows</option>
                                        <option value="macOS">macOS</option>
                                        <option value="Linux">Linux</option>
                                        <option value="Android">Android</option>
                                        <option value="iOS">iOS</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="version">Versión (ej: 64-bit, Universal)</label>
                                    <input type="text" id="version" name="version" required>
                                </div>
                                <div class="form-group">
                                    <label for="icon_class">Clase de Icono (FontAwesome)</label>
                                    <input type="text" id="icon_class" name="icon_class" placeholder="Ej: fab fa-windows" required>
                                </div>
                                <div class="form-group">
                                    <label for="download_file">Archivo (.zip, .exe, etc.)</label>
                                    <input type="file" id="download_file" name="download_file" required>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="action-btn save-btn"><i class="fas fa-upload"></i> Subir y Guardar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN 5: AJUSTES -->
                <section id="settings-manager" class="admin-section">
                    <h3><i class="fas fa-cogs"></i> Ajustes Generales</h3>
                    <div class="settings-grid">
                        <div class="setting-card">
                            <div class="setting-info">
                                <h4>Modo Mantenimiento</h4>
                                <p>Activa esta opción para deshabilitar el acceso al launcher y mostrar un aviso.</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="maintenance-mode-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-card">
                            <div class="setting-info">
                                <h4>Limpiar Caché</h4>
                                <p>Borra los datos temporales del servidor para forzar la recarga de recursos.</p>
                            </div>
                            <div class="setting-control">
                                <button class="action-btn" style="background-color: var(--neon-blue); color: var(--main-bg-color);">Limpiar</button>
                            </div>
                        </div>
                        <div class="setting-card">
                            <div class="setting-info">
                                <h4>Registros de Errores</h4>
                                <p>Ver o limpiar los registros de errores del servidor para diagnosticar problemas.</p>
                            </div>
                            <div class="setting-control">
                                <button class="action-btn" style="border: 1px solid var(--neon-blue); color: var(--neon-blue);">Ver Logs</button>
                                <button class="action-btn" style="border: 1px solid var(--neon-pink); color: var(--neon-pink);">Limpiar Logs</button>
                            </div>
                        </div>
                        <div class="setting-card">
                            <div class="setting-info">
                                <h4>Clave API de Gemini</h4>
                                <p>Configura la clave de API para el asistente de IA. Se guarda de forma segura en el servidor.</p>
                            </div>
                            <div class="setting-control" style="display: flex; gap: 10px;">
                                <input type="password" id="gemini-api-key-input" placeholder="Nueva clave de API" style="flex-grow: 1;">
                                <button class="action-btn save-btn">Guardar</button>
                            </div>
                        </div>
                        <div class="setting-card danger-zone">
                            <div class="setting-info">
                                <h4><i class="fas fa-skull-crossbones"></i> Limpieza Total de Datos</h4>
                                <p>Elimina permanentemente todos los usuarios (excepto admins) y todos los mensajes del chat. <strong>Esta acción es irreversible.</strong></p>
                            </div>
                            <div class="setting-control">
                                <button id="wipe-data-btn" class="action-btn" style="background-color: var(--neon-pink); color: var(--main-bg-color);">Limpiar Datos</button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Botón Flotante Global para el Asistente Gemini -->
    <button id="floating-gemini-btn" class="floating-gemini-btn" title="Abrir Asistente de IA">
        <i class="fas fa-magic"></i>
    </button>

    <!-- Widget de Chat Flotante del Asistente Gemini -->
    <div id="gemini-chat-widget" class="gemini-chat-widget">
        <div class="gemini-widget-header">
            <h3><i class="fas fa-magic"></i> Asistente de IA</h3>
            <div class="widget-controls">
                <button id="gemini-reset-btn" class="widget-control-btn" title="Nueva conversación"><i class="fas fa-sync-alt"></i></button>
                <button id="gemini-widget-close" class="widget-control-btn" title="Cerrar">&times;</button>
            </div>
        </div>
        <div id="gemini-chat-log" class="gemini-chat-log"></div>
        <div class="gemini-input-area">
            <!-- Contenedor para la vista previa del archivo adjunto -->
            <div id="gemini-file-preview-container" class="gemini-file-preview-container" style="display: none;">
                <span id="gemini-file-preview-text"></span>
                <button id="gemini-remove-file-btn" class="remove-file-btn" title="Quitar archivo">&times;</button>
            </div>
            <!-- Sugerencias de Prompts -->
            <div class="gemini-prompt-suggestions">
                <button class="prompt-suggestion-btn" data-prompt="Redacta una noticia sobre una nueva actualización.">Noticia de Actualización</button>
                <button class="prompt-suggestion-btn" data-prompt="Sugiere 3 títulos para una noticia sobre un evento de la comunidad.">Sugerir Títulos</button>
                <button class="prompt-suggestion-btn" data-prompt="Revisa la siguiente descripción para que sea más atractiva:">Revisar Texto</button>
            </div>
            <form id="gemini-chat-form" class="gemini-chat-form">
                <button type="button" id="gemini-mic-btn" class="gemini-chat-control-btn" title="Grabar audio"><i class="fas fa-microphone"></i></button>
                <button type="button" id="gemini-emoji-btn" class="gemini-chat-control-btn"><i class="fas fa-smile"></i></button>
                <label for="gemini-file-input" class="gemini-chat-control-btn file-upload-btn" title="Adjuntar archivo">
                    <i class="fas fa-paperclip"></i>
                </label>
                <input type="file" id="gemini-file-input" style="display: none;">
                <input type="text" id="gemini-chat-input" placeholder="Escribe tu pregunta aquí..." autocomplete="off">
                <button type="submit" class="gemini-chat-send-btn"><i class="fas fa-paper-plane"></i></button>
            </form>
            <div id="gemini-picker-container" class="picker-container"><emoji-picker class="dark"></emoji-picker></div>
        </div>
    </div>

    <footer class="footer">
        <p>GLauncher &copy; 2025. Panel de Administración.</p>
    </footer>

    <audio id="chat-notification-sound" src="sounds/chat_notification.mp3" preload="auto"></audio>
    <script src="js/admin-script.js"></script>
    <script>
    // El contenido completo de admin-script.js se pega aquí para asegurar su funcionamiento.
    document.addEventListener('DOMContentLoaded', () => {
    const BACKEND_URL = 'https://glauncher-api.onrender.com';
    let ADMIN_KEY = null; // Variable para almacenar la clave de admin
    // --- Elementos del DOM ---
    const newsList = document.getElementById('news-list');
    const newsForm = document.getElementById('news-form');
    const formTitle = document.getElementById('form-title');
    const newsIdInput = document.getElementById('news-id');
    const saveBtn = document.getElementById('save-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const addNewBtn = document.getElementById('add-new-btn');
    const imageInput = document.getElementById('image');
    const imagePreview = document.getElementById('image-preview');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const logoutButton = document.getElementById('logout-btn');

    // --- Elementos del Dashboard ---
    const refreshStatusBtn = document.getElementById('refresh-status-btn');


    // --- Elementos del Chat Manager ---
    const systemMessageForm = document.getElementById('system-message-form');
    const systemMessageContent = document.getElementById('system-message-content');
    const adminChatView = document.getElementById('admin-chat-view');
    const deleteAllChatBtn = document.getElementById('delete-all-chat-btn');

    // --- Elementos del Download Manager ---
    const downloadForm = document.getElementById('download-form');
    const downloadsList = document.getElementById('downloads-list');

    // --- Elementos de Ajustes ---
    const wipeDataBtn = document.getElementById('wipe-data-btn');

    // --- Elementos del Cosmetic Manager ---
    const cosmeticForm = document.getElementById('cosmetic-form');
    const cosmeticsList = document.getElementById('cosmetics-list');

    // --- Elementos del Modal de Baneo ---
    const banModal = document.getElementById('ban-modal');
    const banForm = document.getElementById('ban-form');
    const cancelBanBtn = document.getElementById('cancel-ban-btn');

    // --- Elementos del User Manager ---
    const userTableBody = document.getElementById('user-list-body');

    // --- Elementos del Asistente Gemini ---
    const geminiChatWidget = document.getElementById('gemini-chat-widget');
    const geminiWidgetClose = document.getElementById('gemini-widget-close');
    const geminiChatLog = document.getElementById('gemini-chat-log');
    const geminiChatForm = document.getElementById('gemini-chat-form');
    const geminiChatInput = document.getElementById('gemini-chat-input');
    const geminiMicBtn = document.getElementById('gemini-mic-btn');
    const floatingGeminiBtn = document.getElementById('floating-gemini-btn');
    const geminiEmojiBtn = document.getElementById('gemini-emoji-btn');
    const geminiPickerContainer = document.getElementById('gemini-picker-container');
    const notificationSound = document.getElementById('chat-notification-sound');
    const geminiResetBtn = document.getElementById('gemini-reset-btn');
    let geminiChatHistory = []; // Array para almacenar el historial de la conversación

    let currentNews = [];
    let attachedFile = null; // Variable para el archivo adjunto
    let mediaRecorder; // Para grabar audio
    let audioChunks = [];

    const filePreviewContainer = document.getElementById('gemini-file-preview-container');
    const filePreviewText = document.getElementById('gemini-file-preview-text');
    const removeFileBtn = document.getElementById('gemini-remove-file-btn');
    let chatPollInterval = null; // Variable para controlar la actualización del chat

    async function loadNews() {
        try {
            const response = await fetch(`${BACKEND_URL}/api/news`);
            currentNews = await response.json();
            renderNewsList();
        } catch (error) {
            newsList.innerHTML = '<p class="error-msg">Error al cargar noticias.</p>';
            console.error(error);
        }
    }

    function renderNewsList() {
        newsList.innerHTML = '';
        if (currentNews.length === 0) {
            newsList.innerHTML = '<p>No hay noticias para mostrar.</p>';
            return;
        }
        currentNews.forEach(item => {
            const newsItemDiv = document.createElement('div');
            newsItemDiv.className = 'news-list-item';
            newsItemDiv.innerHTML = `
                <div class="item-info" data-id="${item.id}">
                    <span class="item-date">${item.date}</span>
                    <span class="item-title">${item.title}</span>
                </div>
                <div class="item-actions">
                    <button class="edit-btn" data-id="${item.id}"><i class="fas fa-edit"></i></button>
                    <button class="delete-btn" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                </div>
            `;
            newsList.appendChild(newsItemDiv);
        });
    }

    // --- Lógica del Dashboard de Resumen ---
    async function loadDashboardStats() {
        // Cargar estadísticas numéricas
        try {
            const usersResponse = await fetch(`${BACKEND_URL}/api/admin/users`, { credentials: 'include' });
            const newsResponse = await fetch(`${BACKEND_URL}/api/news`);
            const downloadsResponse = await fetch(`${BACKEND_URL}/api/downloads`);

            if (usersResponse.ok) {
                const users = await usersResponse.json();
                document.getElementById('stat-total-users').textContent = users.length;
            }
            if (newsResponse.ok) {
                const news = await newsResponse.json();
                document.getElementById('stat-total-news').textContent = news.length;
            }
            if (downloadsResponse.ok) {
                const downloads = await downloadsResponse.json();
                document.getElementById('stat-total-downloads').textContent = downloads.length;
            }
        } catch (error) { console.error("Error al cargar estadísticas:", error); }
    }

    // --- Lógica para el Status Check del Dashboard ---
    async function checkSystemStatus() {
        const services = ['backend', 'gemini', 'pusher'];
        // Poner todo en estado de carga
        services.forEach(service => {
            const card = document.getElementById(`status-${service}`);
            if (!card) return;
            const indicator = card.querySelector('.status-indicator');
            const text = card.querySelector('.status-text');
            indicator.className = 'status-indicator loading';
            text.textContent = 'Comprobando...';
        });

        try {
            const response = await fetch(`${BACKEND_URL}/api/admin/status`, { credentials: 'include' });
            if (!response.ok) throw new Error('No se pudo obtener el estado.');
            
            const statuses = await response.json();
            
            Object.keys(statuses).forEach(serviceKey => {
                const card = document.getElementById(`status-${serviceKey}`);
                if (card) {
                    const indicator = card.querySelector('.status-indicator');
                    const text = card.querySelector('.status-text');
                    const { status, message } = statuses[serviceKey];
                    
                    indicator.title = message; // Añadir tooltip con más info
                    indicator.className = `status-indicator ${status}`; // 'online' u 'offline'
                    text.textContent = message;
                }
            });

        } catch (error) {
            console.error("Error al comprobar el estado del sistema:", error);
            // Marcar el backend como offline si la petición principal falla
            const backendCard = document.getElementById('status-backend');
            if(backendCard) {
                backendCard.querySelector('.status-indicator').className = 'status-indicator offline';
                backendCard.querySelector('.status-text').textContent = 'La API no responde.';
            }
        }
    }

    if(logoutButton) {
        logoutButton.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch(`${BACKEND_URL}/logout`, { credentials: 'include' });
                if (response.ok) {
                    alert("Has cerrado sesión. Serás redirigido a la página de inicio.");
                    window.location.href = 'index.html';
                } else {
                    throw new Error('Fallo al cerrar sesión.');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        });
    }

    function resetForm() {
        if(!newsForm) return;
        newsForm.reset();
        newsIdInput.value = '';
        formTitle.textContent = 'Crear Nueva Noticia';
        saveBtn.innerHTML = '<i class="fas fa-plus"></i> Crear Noticia';
        cancelBtn.style.display = 'none';
        imagePreview.src = '';
        imagePreviewContainer.style.display = 'none';
        document.getElementById('date').valueAsDate = new Date();
    }

    function populateForm(newsId) {
        const item = currentNews.find(n => n.id === newsId);
        if (!item) return;

        formTitle.textContent = `Editando: ${item.title}`;
        newsIdInput.value = item.id;
        document.getElementById('title').value = item.title;
        document.getElementById('date').value = item.date.split(' ')[0]; // Tomar solo la parte YYYY-MM-DD
        document.getElementById('category').value = item.category;
        document.getElementById('icon').value = item.icon;
        document.getElementById('summary').value = item.summary;
        
        const imageUrl = item.image.startsWith('/uploads/') ? `${BACKEND_URL}${item.image}` : item.image;
        imagePreview.src = imageUrl;
        imagePreviewContainer.style.display = 'block';
        document.getElementById('link').value = item.link;
        document.getElementById('buttonText').value = item.buttonText;

        saveBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
        cancelBtn.style.display = 'inline-block';
    }

    if(newsForm) {
        newsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = newsIdInput.value;
            const formData = new FormData(newsForm);

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${BACKEND_URL}/api/news/update/${id}` : `${BACKEND_URL}/api/news/create`;

            if (id && !imageInput.files[0]) {
                const item = currentNews.find(n => n.id == id);
                formData.append('current_image_path', item.image);
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    credentials: 'include',
                    body: formData
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                alert(result.message);
                resetForm();
                loadNews();

            } catch (error) {
                alert(`Error: ${error.message}`);
                console.error(error);
            }
        });
    }

    if(newsList) {
        newsList.addEventListener('click', (e) => {
            const editButton = e.target.closest('.edit-btn');
            const deleteButton = e.target.closest('.delete-btn');
            const itemInfo = e.target.closest('.item-info');

            if (editButton || itemInfo) {
                const id = parseInt((editButton || itemInfo).dataset.id);
                populateForm(id);
            }

            if (deleteButton) {
                const id = parseInt(deleteButton.dataset.id);
                if (confirm('¿Estás seguro de que quieres eliminar esta noticia? Esta acción no se puede deshacer.')) {
                    deleteNews(id);
                }
            }
        });
    }

    async function deleteNews(id) {
        try {
            const response = await fetch(`${BACKEND_URL}/api/news/delete/${id}`, {
                method: 'DELETE',
                credentials: 'include',
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            
            alert(result.message);
            loadNews();

        } catch (error) {
            alert(`Error: ${error.message}`);
            console.error(error);
        }
    }

    if(addNewBtn) addNewBtn.addEventListener('click', () => resetForm());
    if(cancelBtn) cancelBtn.addEventListener('click', () => resetForm());

    const navItems = document.querySelectorAll('.admin-nav-item');
    const adminSections = document.querySelectorAll('.admin-section');

    navItems.forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = item.dataset.target;

            if (chatPollInterval) {
                clearInterval(chatPollInterval);
                chatPollInterval = null;
            }

            navItems.forEach(nav => nav.classList.remove('active'));
            item.classList.add('active');

            if (targetId === 'chat-manager') {
                loadChatMessages();
                chatPollInterval = setInterval(loadChatMessages, 5000);
            } else if (targetId === 'downloads-manager') {
                loadDownloads();
            } else if (targetId === 'users-manager') {
                loadAllUsersForAdmin();
            } else if (targetId === 'cosmetics-manager') {
                // Cargar cosméticos cuando se selecciona la pestaña
                loadCosmetics();
            } else if (targetId === 'dashboard-manager') {
                loadDashboardStats();
                checkSystemStatus();
            }

            adminSections.forEach(section => {
                section.classList.remove('active');
                if (section.id === targetId) {
                    section.classList.add('active');
                }
            });
        });
    });

    if (refreshStatusBtn) {
        refreshStatusBtn.addEventListener('click', checkSystemStatus);
    }

    async function loadAllUsersForAdmin() {
        if (!userTableBody) return;
        userTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Cargando usuarios...</td></tr>';
        try {
            const response = await fetch(`${BACKEND_URL}/api/admin/users`, { 
                credentials: 'include'
            });
            if (!response.ok) throw new Error('No se pudo obtener la lista de usuarios.');
    
            const users = await response.json();
            renderAdminUsersTable(users);
        } catch (error) {
            userTableBody.innerHTML = `<tr><td colspan="4" class="error-text" style="text-align:center;">${error.message}</td></tr>`;
        }
    }

    function renderAdminUsersTable(users) {
        if (!userTableBody) return;
        userTableBody.innerHTML = '';
        const roles = ["Pico de madera", "Pico de Piedra", "Pico de Hierro", "Pico de Oro", "Pico de Diamante", "Pico de Netherite"];

        users.forEach(user => {
            const row = document.createElement('tr');
            row.dataset.userId = user.id;
            if (user.is_banned) {
                row.classList.add('banned-user');
            }

            const roleOptions = roles.map(role => 
                `<option value="${role}" ${user.role === role ? 'selected' : ''}>${role}</option>`
            ).join('');

            let banStatus = '';
            if (user.is_banned) {
                const banEndDate = new Date(user.banned_until).toLocaleString();
                banStatus = `<div class="ban-status" title="Motivo: ${user.ban_reason || 'No especificado'}"><i class="fas fa-gavel"></i> Baneado hasta: ${banEndDate}</div>`;
            }

            row.innerHTML = `
                <td>${user.id}</td>
                <td>
                    <img src="${user.avatar_url || 'images/avatars/default-avatar.png'}" class="user-avatar-table">
                    ${user.username}
                </td>
                <td>
                    ${banStatus}
                    <select class="role-select">${roleOptions}</select>
                    <label class="toggle-switch">
                        <input type="checkbox" class="admin-checkbox" ${user.is_admin ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                </td>
                <td>
                    <button class="action-btn save-btn" title="Guardar Cambios"><i class="fas fa-save"></i></button>
                    <button class="action-btn ban-btn" title="Sancionar Usuario"><i class="fas fa-gavel"></i></button>
                </td>
            `;
            userTableBody.appendChild(row);
        });
    }

    if(userTableBody) {
        userTableBody.addEventListener('click', async (event) => {
            if (event.target.closest('.save-btn')) {
                const saveButton = event.target;
                const userRow = saveButton.closest('tr');
                const userId = userRow.dataset.userId;
                const roleSelect = userRow.querySelector('.role-select');
                const adminCheckbox = userRow.querySelector('.admin-checkbox');

                const newRole = roleSelect.value;
                const isAdmin = adminCheckbox.checked;

                saveButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                try {
                    const response = await fetch(`${BACKEND_URL}/api/admin/update_user`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ user_id: userId, role: newRole, is_admin: isAdmin }),
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message || 'Error desconocido');
                    alert('Usuario actualizado con éxito');
                } catch (error) {
                    alert(`Error: ${error.message}`);
                } finally {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Guardar';
                }
            }
        });

        userTableBody.addEventListener('click', (e) => {
            if (e.target.closest('.ban-btn')) {
                const userRow = e.target.closest('tr');
                const userId = userRow.dataset.userId;
                openBanModal(userId);
            }
        });
    }

    async function loadChatMessages() {
        if (!adminChatView) return;
        try {
            const response = await fetch(`${BACKEND_URL}/api/chat_messages`, {
                credentials: 'include'
            });
            if (!response.ok) throw new Error('No se pudieron cargar los mensajes.');
            const messages = await response.json();
            renderChatMessages(messages);
        } catch (error) {
            adminChatView.innerHTML = `<p style="color: var(--neon-pink);">${error.message}</p>`;
        }
    }

    function renderChatMessages(messages) {
        adminChatView.innerHTML = '';
        messages.forEach(msg => {
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${msg.username === 'Sistema' ? 'system' : 'user'}`;
            
            let contentHTML;
            if (msg.type === 'gif') {
                contentHTML = `<strong>${msg.username}:</strong><br><img src="${msg.content}" alt="GIF" class="chat-gif">`;
            } else {
                contentHTML = `<strong>${msg.username}:</strong> ${msg.content}`;
            }

            msgDiv.innerHTML = `
                <p>${contentHTML}</p>
                <button class="delete-chat-btn" data-id="${msg.id}" title="Eliminar mensaje">&times;</button>
            `;
            adminChatView.appendChild(msgDiv);
        });
        adminChatView.scrollTop = adminChatView.scrollHeight;
    }

    if(systemMessageForm) {
        systemMessageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = systemMessageContent.value.trim();
            if (!content) return;

            try {
                const response = await fetch(`${BACKEND_URL}/api/chat_messages/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username: 'Sistema', content: content, type: 'text' })
                });
                if (!response.ok) throw new Error('No se pudo enviar el mensaje.');
                
                alert('Mensaje del sistema enviado con éxito.');
                systemMessageContent.value = '';
                loadChatMessages();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        });
    }

    if(adminChatView) {
        adminChatView.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-chat-btn')) {
                const messageId = e.target.dataset.id;
                if (confirm('¿Estás seguro de que quieres eliminar este mensaje del chat?')) {
                    const btn = e.target;
                    btn.disabled = true;
                    try {
                        const response = await fetch(`${BACKEND_URL}/api/chat_messages/${messageId}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });
                        if (!response.ok) throw new Error((await response.json()).message || 'No se pudo eliminar el mensaje.');
                        
                        loadChatMessages();
                    } catch (error) {
                        alert(`Error: ${error.message}`);
                    }
                }
            }
        });
    }

    if(deleteAllChatBtn) {
        deleteAllChatBtn.addEventListener('click', async () => {
            if (confirm('¿ESTÁS COMPLETAMENTE SEGURO?\nEsta acción borrará permanentemente TODOS los mensajes del chat y no se puede deshacer.')) {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/chat_messages/all`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        const result = await response.json();
                        throw new Error(result.message || 'No se pudo limpiar el chat.');
                    }
                    
                    alert((await response.json()).message);
                    loadChatMessages();
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            }
        });
    }

    async function loadDownloads() {
        if (!downloadsList) return;
        try {
            const response = await fetch(`${BACKEND_URL}/api/downloads`, {
                credentials: 'include'
            });
            if (!response.ok) throw new Error('No se pudieron cargar las descargas.');
            const downloads = await response.json();
            renderDownloadsList(downloads);
        } catch (error) {
            downloadsList.innerHTML = `<p style="color: var(--neon-pink);">${error.message}</p>`;
        }
    }

    function renderDownloadsList(downloads) {
        downloadsList.innerHTML = '';
        if (downloads.length === 0) {
            downloadsList.innerHTML = '<p>No hay archivos de descarga configurados.</p>';
            return;
        }
        downloads.forEach(item => {
            const downloadItemDiv = document.createElement('div');
            downloadItemDiv.className = 'news-list-item';
            downloadItemDiv.innerHTML = `
                <div class="item-info">
                    <span class="item-date"><i class="${item.icon_class}"></i> ${item.platform}</span>
                    <span class="item-title">${item.version}</span>
                </div>
                <div class="item-actions">
                    <button class="delete-download-btn" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                </div>
            `;
            downloadsList.appendChild(downloadItemDiv);
        });
    }

    if(downloadForm) {
        downloadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(downloadForm);
            const submitBtn = downloadForm.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...';

            try {
                const response = await fetch(`${BACKEND_URL}/api/downloads/create`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                alert(result.message);
                downloadForm.reset();
                loadDownloads();
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });
    }

    if(downloadsList) {
        downloadsList.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-download-btn')) {
                const btn = e.target.closest('.delete-download-btn');
                const downloadId = btn.dataset.id;
                if (confirm('¿Estás seguro de que quieres eliminar este archivo de descarga? El archivo físico también será borrado del servidor.')) {
                    deleteDownload(downloadId);
                }
            }
        });
    }

    // --- Lógica para el Modal de Baneo ---
    function openBanModal(userId) {
        document.getElementById('ban-user-id').value = userId;
        banModal.style.display = 'flex';
    }

    function closeBanModal() {
        banModal.style.display = 'none';
        banForm.reset();
    }

    if (banForm) {
        banForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('ban-user-id').value;
            const duration = parseInt(document.getElementById('ban-duration').value);
            const reason = document.getElementById('ban-reason').value;
            const submitBtn = banForm.querySelector('button[type="submit"]');

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/users/ban`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ user_id: userId, duration_hours: duration, reason: reason })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                
                alert(result.message);
                closeBanModal();
                loadAllUsersForAdmin(); // Recargar la lista de usuarios
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Aplicar';
            }
        });
    }

    if (cancelBanBtn) cancelBanBtn.addEventListener('click', closeBanModal);

    // --- Lógica para el Gestor de Cosméticos ---
    async function loadCosmetics() {
        if (!cosmeticsList) return;
        cosmeticsList.innerHTML = '<p>Cargando cosméticos...</p>';
        try {
            const response = await fetch(`${BACKEND_URL}/api/shop/items`);
            if (!response.ok) throw new Error('No se pudieron cargar los cosméticos.');
            const items = await response.json();
            renderCosmeticsList(items);
        } catch (error) {
            cosmeticsList.innerHTML = `<p class="error-text">${error.message}</p>`;
        }
    }

    function renderCosmeticsList(items) {
        cosmeticsList.innerHTML = '';
        if (items.length === 0) {
            cosmeticsList.innerHTML = '<p>No hay cosméticos creados.</p>';
            return;
        }
        items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'news-list-item'; // Reutilizamos estilo
            itemDiv.innerHTML = `
                <div class="item-info">
                    <span class="item-date">${item.category}</span>
                    <span class="item-title">${item.name}</span>
                </div>
                <div class="item-actions">
                    <button class="delete-cosmetic-btn" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                </div>
            `;
            cosmeticsList.appendChild(itemDiv);
        });
    }

    if (cosmeticForm) {
        cosmeticForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(cosmeticForm);
            const submitBtn = cosmeticForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';

            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/cosmetics/create`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                alert(result.message);
                cosmeticForm.reset();
                loadCosmetics();
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-upload"></i> Crear Ítem';
            }
        });
    }

    // --- Lógica de Ajustes ---
    if (wipeDataBtn) {
        wipeDataBtn.addEventListener('click', async () => {
            if (confirm('ADVERTENCIA: Estás a punto de borrar TODOS los usuarios no administradores y TODOS los mensajes del chat. ¿Estás seguro de que quieres continuar?')) {
                if (confirm('CONFIRMACIÓN FINAL: Esta acción es irreversible. ¿Realmente quieres proceder con la limpieza total de datos?')) {
                    wipeDataBtn.disabled = true;
                    wipeDataBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Limpiando...';
                    try {
                        const response = await fetch(`${BACKEND_URL}/api/admin/wipe_all_data`, {
                            method: 'POST',
                            credentials: 'include'
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.message);
                        alert(result.message);
                    } catch (error) {
                        alert(`Error: ${error.message}`);
                    } finally {
                        wipeDataBtn.disabled = false;
                        wipeDataBtn.innerHTML = 'Limpiar Datos';
                    }
                }
            }
        });
    }

    async function deleteDownload(id) {
        try {
            const response = await fetch(`${BACKEND_URL}/api/downloads/delete/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            
            alert(result.message);
            loadDownloads();

        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    function addMessageToGeminiChat(text, sender) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('gemini-chat-message', sender);

        if (sender === 'assistant') {
            messageElement.innerHTML = `<p>${text}</p><button class="copy-assistant-response-btn" title="Copiar respuesta"><i class="far fa-copy"></i></button>`;
        } else {
            messageElement.innerHTML = `<p>${text}</p>`;
        }

        geminiChatLog.appendChild(messageElement);
        geminiChatLog.scrollTop = geminiChatLog.scrollHeight;

        if (notificationSound) {
            notificationSound.currentTime = 0;
            notificationSound.play().catch(e => console.warn("No se pudo reproducir el sonido:", e));
        }
    }

    const geminiFileInput = document.getElementById('gemini-file-input');

    async function sendPromptToGemini(prompt, sectionContext = null) {
        const file = attachedFile;
        let userMessage = prompt;
        if (file) userMessage += ` (Archivo adjunto: ${file.name})`;
        if (!prompt && file) {
            userMessage = `Analiza el siguiente archivo: ${file.name}`;
            prompt = `Analiza el siguiente archivo.`;
        }

        addMessageToGeminiChat(userMessage, 'user');
        geminiChatInput.value = '';
        if(geminiFileInput) geminiFileInput.value = '';
        toggleGeminiSendButton();

        geminiChatHistory.push({ role: 'user', parts: [{ text: prompt }] });
        clearAttachedFile();

        addMessageToGeminiChat("Pensando...", 'assistant');
        
        const formData = new FormData();
        formData.append('history', JSON.stringify(geminiChatHistory));
        if (sectionContext) formData.append('section', sectionContext);
        if (file) formData.append('file', file);

        try {
            const response = await fetch(`${BACKEND_URL}/api/gemini-chat`, {
                method: 'POST',
                credentials: 'include',
                body: formData
            });
            const data = await response.json();
            
            const loadingMessage = geminiChatLog.querySelector('.assistant:last-child');
            if (loadingMessage) loadingMessage.querySelector('p').innerHTML = data.answer; // Use innerHTML to render markdown
            geminiChatHistory.push({ role: 'model', parts: [{ text: data.answer }] });

        } catch (error) {
            const loadingMessage = geminiChatLog.querySelector('.assistant:last-child');
            if (loadingMessage) loadingMessage.querySelector('p').textContent = "Error de conexión con el asistente. Inténtalo de nuevo.";
            console.error("Error en el chat de Gemini:", error);
        }
    }

    if(geminiResetBtn) {
        geminiResetBtn.addEventListener('click', () => {
            geminiChatLog.innerHTML = '';
            geminiChatHistory = [];
            const currentSection = geminiChatLog.dataset.currentSection || 'general';
            addMessageToGeminiChat(`Hola, soy tu asistente de GLauncher. ¿En qué puedo ayudarte con la sección de ${currentSection.replace('-', ' ').toUpperCase()}?`, 'assistant');
            geminiChatInput.focus();
        });
    }

    if(geminiWidgetClose) geminiWidgetClose.addEventListener('click', () => geminiChatWidget.classList.remove('visible'));

    if(geminiChatForm) {
        geminiChatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userPrompt = geminiChatInput.value.trim();
            const currentSection = geminiChatLog.dataset.currentSection;
            if (userPrompt || attachedFile) {
                sendPromptToGemini(userPrompt, currentSection);
            }
        });
    }

    const geminiSendBtn = geminiChatForm ? geminiChatForm.querySelector('.gemini-chat-send-btn') : null;
    function toggleGeminiSendButton() {
        if(geminiSendBtn) geminiSendBtn.disabled = geminiChatInput.value.trim() === '' && !attachedFile;
    }
    if(geminiChatInput) geminiChatInput.addEventListener('input', toggleGeminiSendButton);
    toggleGeminiSendButton();

    if(geminiChatLog) {
        geminiChatLog.addEventListener('click', (e) => {
            const copyBtn = e.target.closest('.copy-assistant-response-btn');
            if (copyBtn) {
                const messageText = copyBtn.previousElementSibling.textContent;
                navigator.clipboard.writeText(messageText).then(() => {
                    const icon = copyBtn.querySelector('i');
                    icon.className = 'fas fa-check';
                    copyBtn.title = "¡Copiado!";
                    setTimeout(() => {
                        icon.className = 'far fa-copy';
                        copyBtn.title = "Copiar respuesta";
                    }, 2000);
                }).catch(err => console.error('Error al copiar:', err));
            }
        });
    }

    if(geminiEmojiBtn) {
        geminiEmojiBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            geminiPickerContainer.classList.toggle('show');
        });
    }

    document.addEventListener('click', (event) => {
        if(geminiPickerContainer && geminiEmojiBtn) {
            const isClickInsidePicker = geminiPickerContainer.contains(event.target);
            const isClickOnEmojiButton = geminiEmojiBtn.contains(event.target);
            if (!isClickInsidePicker && !isClickOnEmojiButton) {
                geminiPickerContainer.classList.remove('show');
            }
        }
    });

    const emojiPicker = document.querySelector('#gemini-picker-container emoji-picker');
    if (emojiPicker) {
        emojiPicker.addEventListener('emoji-click', event => {
            geminiChatInput.value += event.detail.unicode;
            geminiChatInput.focus();
        });
    }

    if(imageInput) {
        imageInput.addEventListener('change', () => {
            const file = imageInput.files[0];
            if (file) {
                imagePreview.src = URL.createObjectURL(file);
                imagePreviewContainer.style.display = 'block';
            }
        });
    }

    if(floatingGeminiBtn) {
        floatingGeminiBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = geminiChatWidget.classList.toggle('visible');

            if (isVisible) {
                const activeSection = document.querySelector('.admin-section.active');
                const sectionId = activeSection ? activeSection.id.replace('-manager', '') : 'general';

                if (geminiChatLog.children.length === 0) {
                    addMessageToGeminiChat(`Hola, soy tu asistente. ¿En qué puedo ayudarte con la sección de ${sectionId.replace('-', ' ').toUpperCase()}?`, 'assistant');
                }
                geminiChatLog.dataset.currentSection = sectionId;
            }
        });
    }

    function handleFileAttachment(file) {
        if (!file) return;
        attachedFile = file;
        filePreviewText.textContent = `Adjunto: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
        filePreviewContainer.style.display = 'flex';
        toggleGeminiSendButton();
    }

    function clearAttachedFile() {
        attachedFile = null;
        if(geminiFileInput) geminiFileInput.value = '';
        filePreviewContainer.style.display = 'none';
        toggleGeminiSendButton();
    }

    if(geminiFileInput) geminiFileInput.addEventListener('change', () => handleFileAttachment(geminiFileInput.files[0]));
    if(removeFileBtn) removeFileBtn.addEventListener('click', clearAttachedFile);

    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            audioChunks = [];

            mediaRecorder.addEventListener("dataavailable", event => audioChunks.push(event.data));

            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioFile = new File([audioBlob], "grabacion.webm", { type: 'audio/webm' });
                handleFileAttachment(audioFile);
                stream.getTracks().forEach(track => track.stop());
            });

            geminiMicBtn.classList.add('recording');
            geminiMicBtn.title = "Detener grabación";
            geminiMicBtn.querySelector('i').className = 'fas fa-stop';

        } catch (err) {
            console.error("Error al acceder al micrófono:", err);
            alert("No se pudo acceder al micrófono. Asegúrate de haber dado los permisos necesarios.");
        }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
            geminiMicBtn.classList.remove('recording');
            geminiMicBtn.title = "Grabar audio";
            geminiMicBtn.querySelector('i').className = 'fas fa-microphone';
        }
    }

    if(geminiMicBtn) {
        geminiMicBtn.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                stopRecording();
            } else {
                if (attachedFile) {
                    if (confirm("Ya tienes un archivo adjunto. ¿Quieres reemplazarlo con una grabación de audio?")) {
                        clearAttachedFile();
                        startRecording();
                    }
                } else {
                    startRecording();
                }
            }
        });
    }

    document.querySelectorAll('.prompt-suggestion-btn').forEach(button => {
        button.addEventListener('click', () => {
            geminiChatInput.value = button.dataset.prompt;
            geminiChatInput.focus();
            toggleGeminiSendButton();
        });
    });
    
    // Cargar contenido inicial del panel
    loadDashboardStats();
    checkSystemStatus();
    loadNews();
});
    </script>
</body>
</html>